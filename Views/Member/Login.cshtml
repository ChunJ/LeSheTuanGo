@model LeSheTuanGo.ViewModels.MemberViewModel
@{
    ViewData["Title"] = "Login";
}

<h1>登入</h1>

<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Login" id="form">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input hidden name="from" value="@ViewData["from"]"/>
            <div class="form-group">
                <label asp-for="Email" class="control-label" id="labelEmail"></label>
                <input asp-for="Email" class="form-control" id="txtEmail"/>
                <span asp-validation-for="Email" class="text-danger" id="spanEmail"></span>
            </div>
            <div class="form-group">
                <label asp-for="Password" class="control-label" id="labelPassword"></label>
                <input asp-for="Password" class="form-control" id="txtPassword"/>
                <span asp-validation-for="Password" class="text-danger" id="spanPassword"></span>
            </div>
            <div class="form-group">
                <input type="button" value="登入" class="btn btn-primary" onclick="checkLogin()" />
                <a asp-action="forgetPassword" type="button" class="btn btn-primary" >忘記密碼</a>
                <a asp-action="Create" type="button" class="btn btn-primary" >註冊</a>
            </div>
            @*<div class="g-recaptcha" data-sitekey="6LdLl4UaAAAAAJHIzFhcfwmN2Gui1oNs9L-3lEJM"></div>*@
            <div class="form-group">
                <input type="button" value="Demo" class="btn btn-primary" onclick="demo()" />
            </div>
        </form>
    </div>
</div>


<script src="https://www.google.com/recaptcha/api.js"></script>
<script>
    let txtEmail = document.getElementById("txtEmail");
    let spanEmail = document.getElementById("spanEmail");
    let labelEmail = document.getElementById("labelEmail");
    let txtPassword = document.getElementById("txtPassword");
    let spanPassword = document.getElementById("spanPassword");
    let labelPassword = document.getElementById("labelPassword");
    let form = document.getElementById("form");
    function checkLogin() {
        if (!isNull())
            return;
        isUser(txtEmail, txtPassword);
    }//ok
    function isUser(Email, Password) {
        $.ajax({
            url: "/Member/checkLogin?inputEmail=" + Email.value + "&inputPassword=" + Password.value,
            type: "Get",
            success: function (returnMessage) {
                let js = JSON.parse(returnMessage);
                if (js != "not User" && js != "incorrect" && js != "not Validate") {
                    labelEmail.style.color = "green";
                    txtEmail.style.borderColor = "green";
                    labelPassword.style.color = "green";
                    txtPassword.style.borderColor = "green";
                    form.submit();
                } else if (js == "not User") {
                    spanEmail.innerHTML = "此Email尚未註冊,或嘗試<a href='/Member/Create'>註冊</a>?";
                    spanPassword.innerHTML = "";
                    labelEmail.style.color = "red";
                    txtEmail.style.borderColor = "red";
                } else if (js == "incorrect") {
                    spanEmail.innerHTML = "";
                    spanPassword.innerHTML = "密碼錯誤";
                    labelPassword.style.color = "red";
                    txtPassword.style.borderColor = "red";
                } else if (js == "not Validate") {
                    spanEmail.innerHTML = "Email驗證尚未通過,或<a href='/Member/reSendEmail?Email=" + Email.value+"'> 重新發送驗證信</a >? ";
                    spanPassword.innerHTML = "";
                    labelEmail.style.color = "red";
                    txtEmail.style.borderColor = "red";
                }
            }
        });
    }//ok
    function isNull() {
        if (txtEmail.value == "" && txtPassword.value == "") {
            spanEmail.innerHTML = "不可為空";
            spanPassword.innerHTML = "不可為空";
            labelEmail.style.color = "red";
            labelPassword.style.color = "red";
            txtEmail.style.borderColor = "red";
            txtPassword.style.borderColor = "red";
            return false;
        }
        if (txtEmail.value == "") {
            spanEmail.innerHTML = "不可為空";
            labelEmail.style.color = "red";
            txtEmail.style.borderColor = "red";
            return false;
        } 
        if (txtPassword.value == "") {
            spanPassword.innerHTML = "不可為空";
            labelPassword.style.color = "red";
            txtPassword.style.borderColor = "red";
            return false;
        } else
            return true;
    }//ok

    //demo
    function demo() {
        txtEmail.value = "YuChen789@gmail.com";
        txtPassword.value = "Password123";
    }
    //$captcha = $_POST['g-recaptcha-response'];
    //$secretKey = "6LdLl4UaAAAAAJHIzFhcfwmN2Gui1oNs9L";
    //$ip = $_SERVER['REMOTE_ADDR'];

    //$url = 'https://www.google.com/recaptcha/api/siteverify?secret='.urlencode($secretKey).  '&response='.urlencode($captcha);
    //$response = file_get_contents($url);
    //$responseKeys = json_decode($response, true);

    //if ($responseKeys["success"]) {// success
    //} else {// error
    //}
    //todo
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
